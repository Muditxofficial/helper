from bs4 import BeautifulSoup

def extract_eml_data(eml_path):
    metadata = {
        "From": "", "Sent": "", "To": "", "Cc": "", "Attachments": "", "Body": ""
    }
    try:
        with open(eml_path, 'r', encoding='utf-8', errors='ignore') as f:
            msg = message_from_file(f)

        metadata["From"] = msg.get('From', '')
        metadata["Sent"] = msg.get('Date', '')
        metadata["To"] = msg.get('To', '')
        metadata["Cc"] = msg.get('Cc', '')

        attachments = []
        plain_body = None
        html_body = None

        if msg.is_multipart():
            for part in msg.walk():
                filename = part.get_filename()
                content_type = part.get_content_type()

                if filename:
                    attachments.append(filename)

                elif content_type == "text/plain" and plain_body is None:
                    payload = part.get_payload(decode=True)
                    if payload:
                        plain_body = payload.decode(part.get_content_charset() or 'utf-8', errors='ignore')

                elif content_type == "text/html" and html_body is None:
                    payload = part.get_payload(decode=True)
                    if payload:
                        html_body = payload.decode(part.get_content_charset() or 'utf-8', errors='ignore')
        else:
            content_type = msg.get_content_type()
            payload = msg.get_payload(decode=True)
            if payload:
                decoded = payload.decode(msg.get_content_charset() or 'utf-8', errors='ignore')
                if content_type == "text/plain":
                    plain_body = decoded
                elif content_type == "text/html":
                    html_body = decoded

        if plain_body:
            body = plain_body
        elif html_body:
            soup = BeautifulSoup(html_body, 'html.parser')
            body = soup.get_text()
        else:
            body = ""

        metadata["Attachments"] = '; '.join(attachments)
        metadata["Body"] = body.strip()

    except Exception as e:
        print(f"‚ùå Error reading {eml_path}: {e}")

    return metadata
